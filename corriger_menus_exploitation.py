#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CORRECTION DES MENUS EXPLOITATION DUPLIQU√âS
Supprime le menu exploitation sans ic√¥ne et garde celui avec ic√¥ne
"""

import xmlrpc.client

def corriger_menus_exploitation():
    """Corrige le probl√®me des deux menus exploitation"""
    
    url = "http://localhost:10020"
    db = "odoo123"
    username = "hajar"
    password = "hajar"
    
    try:
        print("üîß CORRECTION DES MENUS EXPLOITATION DUPLIQU√âS")
        print("=" * 60)
        print("üéØ Suppression du menu sans ic√¥ne, conservation du menu avec ic√¥ne")
        print("=" * 60)
        
        # Connexion
        common = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/common')
        uid = common.authenticate(db, username, password, {})
        models = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/object')
        
        print("‚úÖ Connect√© √† Odoo")
        
        # 1. IDENTIFIER LES MENUS EXPLOITATION
        print("\nüîç IDENTIFICATION DES MENUS EXPLOITATION")
        print("-" * 50)
        
        menus_exploitation = models.execute_kw(db, uid, password, 'ir.ui.menu', 'search_read', 
                                             [[('name', 'ilike', 'Exploitation')]], 
                                             {'fields': ['name', 'id', 'parent_id', 'sequence', 'web_icon', 'action']})
        
        print(f"  üìã Menus Exploitation trouv√©s: {len(menus_exploitation)}")
        
        for menu in menus_exploitation:
            parent_id = menu.get('parent_id', [0])[0] if menu.get('parent_id') else 0
            icone = menu.get('web_icon', 'N/A')
            action = menu.get('action', 'N/A')
            print(f"    - ID {menu['id']}: '{menu['name']}' - Parent: {parent_id} - Ic√¥ne: {icone} - Action: {action}")
        
        # 2. IDENTIFIER LE MENU √Ä SUPPRIMER
        print("\nüéØ IDENTIFICATION DU MENU √Ä SUPPRIMER")
        print("-" * 50)
        
        # Chercher le menu sans ic√¥ne et sans action
        menu_a_supprimer = None
        menu_a_garder = None
        
        for menu in menus_exploitation:
            if not menu.get('web_icon') and not menu.get('action'):
                menu_a_supprimer = menu
                print(f"  ‚ùå Menu √† supprimer: ID {menu['id']} - '{menu['name']}' (sans ic√¥ne, sans action)")
            elif menu.get('web_icon') or menu.get('action'):
                menu_a_garder = menu
                print(f"  ‚úÖ Menu √† garder: ID {menu['id']} - '{menu['name']}' (avec ic√¥ne/action)")
        
        # 3. SUPPRIMER LE MENU DUPLIQU√â
        if menu_a_supprimer:
            print(f"\nüóëÔ∏è SUPPRESSION DU MENU DUPLIQU√â")
            print("-" * 50)
            
            try:
                models.execute_kw(db, uid, password, 'ir.ui.menu', 'unlink', [menu_a_supprimer['id']])
                print(f"  ‚úÖ Menu supprim√©: ID {menu_a_supprimer['id']} - '{menu_a_supprimer['name']}'")
            except Exception as e:
                print(f"  ‚ùå Erreur lors de la suppression: {str(e)}")
        else:
            print("  ‚ÑπÔ∏è Aucun menu √† supprimer trouv√©")
        
        # 4. V√âRIFIER LE R√âSULTAT FINAL
        print(f"\n‚úÖ V√âRIFICATION FINALE")
        print("-" * 50)
        
        menus_finaux = models.execute_kw(db, uid, password, 'ir.ui.menu', 'search_read', 
                                       [[('name', 'ilike', 'Exploitation')]], 
                                       {'fields': ['name', 'id', 'parent_id', 'sequence', 'web_icon', 'action']})
        
        print(f"  üìã Menus Exploitation restants: {len(menus_finaux)}")
        
        for menu in menus_finaux:
            parent_id = menu.get('parent_id', [0])[0] if menu.get('parent_id') else 0
            icone = menu.get('web_icon', 'N/A')
            action = menu.get('action', 'N/A')
            print(f"    - ID {menu['id']}: '{menu['name']}' - Parent: {parent_id} - Ic√¥ne: {icone} - Action: {action}")
        
        # 5. R√âSUM√â DE LA CORRECTION
        print(f"\nüéâ R√âSUM√â DE LA CORRECTION")
        print("=" * 50)
        
        if len(menus_finaux) == 1:
            print("  ‚úÖ SUCC√àS: Un seul menu Exploitation restant")
            print("  ‚úÖ Le menu avec ic√¥ne a √©t√© conserv√©")
            print("  ‚úÖ Le menu dupliqu√© a √©t√© supprim√©")
        else:
            print(f"  ‚ö†Ô∏è ATTENTION: {len(menus_finaux)} menus Exploitation restants")
            print("  ‚ÑπÔ∏è V√©rifiez manuellement dans l'interface Odoo")
        
        print(f"\nüåê V√©rifiez le r√©sultat sur: http://localhost:10020")
        print(f"üìã Le menu Exploitation devrait maintenant √™tre unique")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur lors de la correction: {str(e)}")
        return False

if __name__ == "__main__":
    corriger_menus_exploitation()
